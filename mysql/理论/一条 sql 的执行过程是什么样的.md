### 一条 sql 的执行过程是怎么样的？

### 概述
大概分了 5 步走。
##### 连接器
##### 查询缓存
##### 分析器
##### 优化器
##### 执行器

逻辑示意图

![逻辑示意图](https://github.com/kareTauren/pratice/blob/master/mysql/%E7%90%86%E8%AE%BA/img/1.png)

Server 层包括连接器，查询缓存，分析器，优化器，执行器
存储引擎层负责数据存储和提取，它支持 Innodb，MyISAM，Memory等多个存储引擎。从 5.5.5 以后默认的存储引擎是 Innodb.

##### 连接
1. 连接到 mysql 服务器
2. 授权用户是否可以加入进入 mysql 服务器

通常命名如下：
> mysql -u root -p 123456 -P 3306 -h 127.0.0.1

如果密码用户名正确，就可以进入数据库，操作该用户权限范围内允许的操作了。这里就是一些列的
如果你连接到了 mysql 服务器，你可以使用 `show processlist` 查看当前用户权限下，有多少个数据库连接。

##### 查询缓存
连接建立后，如果你执行 Select 语句，执行逻辑就会来到第二部，查询缓存。
之前执行过的 sql 语句及结果可能会以 Key - value 的形式存入到内存中。`key`是查询的语句，value 是查询的结果，mysql 如果拿到查询语句，会去缓存里看看有没有缓存，如果有就直接返回了，这样的查询过程就非常的快了。

如果查询的语句没有在缓存中，就会继续后面的执行过程。执行完成后，结果会被写入到查询缓存中。但是其否启用查询缓存，就要看需求了。因为如果 sql 中稍微有变动，mysql 就会自动清理掉之前的缓存，然后存入新的缓存，也就意味着你之前存入的缓存有可能还没被用到，就又被清理了。但是一些不经常改的数据可以存储在启用这个缓存，比如配置表，好多年不该一次的。😀

你可以在mysql 的环境变量中查看。使用
`show variables like "%query_cache_type%";` 或者命令 `select @@query_cache_type`
```
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| query_cache_type | OFF   |
+------------------+-------+
```
mysql 默认是 `off` , 你可以在配置文件 my.cnf 中设置值。

`query_cache_type` 总共有三个值

```
0 or OFF 不要在查询缓存中缓存结果或从查询缓存中检索结果
1 or ON 缓存除以 SELECT SQL_NO_CACHE 开头的所有可缓存查询结果 。
2 or DEMAND 仅适用于以 SELECT SQL_CACHE 开头的可缓存查询的缓存结果
```

我在 my.cnf，中设置了 `query_cache_type=2`, 使用 `select @@query_cache_type`可看到。
```
+--------------------+
| @@query_cache_type |
+--------------------+
| DEMAND             |
+--------------------+
```
缓存设置以及改变了。
如果你还是想在缓存中缓存一个表，那改咋办了。你可以使用
> select SQL_CACHE * from tbl_config where ID=99999;

这样就显示的启用了缓存该表了。
不过需要注意的是 `8.0` 已经将整个缓存模块移除了，也就是说 8.0 以后没有这个功能了。

##### 分析器
1. 词法分析
2. 语法分析
首先，是词法分析，你输入的 sql 语句是一串 `字符` + `空格` 的语句。mysql 需要识别你输入的是啥，比如会把 ` select` 识别为一条更新语句，把 `tbl_config` 识别为 `表名 tbl_config`。
其次，就是词法分析，分析你是不是少打了摸个字符等，比如 `selec * from tbl_config`。mysql 会去检查，你是否输入的正确，在这里会表错，提示你 `selec` 打错了的错误提示.

##### 优化器
经过前面的处理，mysql 就知道你要做什么了，在开始执行前，还需要经过优化器处理。优化器是在表里有多个索引的时候，决定使用哪个索引，或者在多表联查时，决定各个表的链接顺序。往往执行逻辑是一样的，但是执行效率是不同的，优化器的作用就是决定选择哪一个方案。

##### 执行器
经过了分析阶段，优化阶段，到了执行阶段，mysql 就确定你要干啥了。这个时候会做一个权限验证。比如检查触发器等是否可操作，因为前面几个阶段是无法检查除了 sql 字面上以为的内容的，只有权限验证通过了。我们才会去打开表执行。当打开表的时候，执行器会根据表的定义的引擎去使用引擎提供的接口来查询。
比如我们要查询的语句是
> select * from tbl_config where ID=100

执行器的执行流程如下：
1. 调用 Innodb 引擎接口取出 tbl_config 表的第一条，判断 ID 值是不是 100，如果不是则跳过，如果是则存入结果集中.
2. 调用引擎接口取 下一行，重复相同的判断逻辑，直到取到这个表的最后一行。
3. 执行器将上述过程中满足条件的结果集返回给客户端。

到这里，一条 sql 语句就完成了。